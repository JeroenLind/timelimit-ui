<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLimit UI v60 - Session Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <strong>TimeLimit UI v60</strong>
        <div>
            <button class="btn btn-wizard" style="background: #673ab7;" onclick="startCreateFlow()">üÜï Nieuwe Familie</button>
            <button class="btn btn-wizard" style="background: #03a9f4;" onclick="startLoginFlow()">üîë Inloggen op Familie</button>
            <button class="btn" style="background:#444" onclick="location.reload()">üîÑ Reset UI</button>
        </div>
        <div style="display: inline-block; margin-left: 15px; padding: 4px 8px; background: #151921; border-radius: 4px; border: 1px solid #333;">
          <span style="font-size: 10px; color: #888; text-transform: uppercase; margin-right: 5px;">Server:</span>
          <select id="server-select" onchange="switchServer(this.value)" style="background: transparent; color: #03a9f4; border: none; font-size: 11px; font-family: monospace; cursor: pointer; outline: none;">
            <option value="http://192.168.68.30:8080">üè† Lokaal</option>
            <option value="https://api.timelimit.io">üåç Officieel</option>
          </select>
        </div>
    </header>

    <div id="wizard-ui" class="wizard-container">
        <div id="step-1" class="wizard-step" style="display:none;">
            <h3 id="step-1-title">Stap 1: E-mailadres</h3>
            <input type="email" id="mail" placeholder="e-mailadres">
            <button class="btn" onclick="runStep1()">Code aanvragen</button>
        </div>
        <div id="step-2" class="wizard-step" style="display:none;">
            <h3>Stap 2: Woord-code</h3>
            <input type="text" id="code" placeholder="woord1 woord2 woord3">
            <button class="btn" onclick="runStep2()">Valideer Code</button>
        </div>
        <div id="step-3" class="wizard-step" style="display:none;">
            <h3>Stap 3: Ouder Wachtwoord</h3>
            <p id="step-3-desc" style="font-size: 11px; color: #888; margin-bottom: 10px;"></p>
            <input type="password" id="pass" placeholder="Wachtwoord">
            <button id="btn-run-create" class="btn" style="display:none;" onclick="runStep3()">Familie Finaliseren & Aanmaken</button>
            <button id="btn-run-login" class="btn" style="display:none; background: #03a9f4;" onclick="runSignInStep3()">Inloggen & Dashboard Koppelen</button>
        </div>
        <button class="btn" style="background:transparent; color:#888; margin-top:10px;" onclick="showStep(0)">‚úñ Annuleren</button>
    </div>

    <div class="main-container">
        <div class="dashboard-view">
            <div id="session-info" style="background: #151921; padding: 15px; border-radius: 8px; border: 1px solid #03a9f4; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #03a9f4; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Actieve Sessie</h4>
                <div id="active-token-display" style="font-family: monospace; font-size: 11px; color: #aaa; word-break: break-all; background: #050505; padding: 8px; border-radius: 4px; min-height: 20px;">
                    Token: <span style="color: #fff;">Laden...</span>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" style="background: #f44336; flex: 1; font-size: 12px;" onclick="logout()">Uitloggen</button>
                    <button class="btn" style="background: #03a9f4; flex: 1; font-size: 12px;" onclick="showLoginModal()">Token Beheer</button>
                </div>
            </div>

            <div id="status-badge" class="status-badge status-offline">Sync Status...</div>
            
            <h2>Gebruikers</h2>
            <div id="user-list">Gegevens ophalen via sync...</div>

            <h2 style="margin-top: 40px;">Categorie Structuur</h2>
            <div id="category-tree-container" class="tree-container">
                Wachtend op hi√´rarchie data...
            </div>

            <div style="margin-top: 30px; padding: 15px; background: #151921; border-radius: 8px; border: 1px solid #232a35; max-width: 300px;">
                <h4 style="margin: 0 0 10px 0; color: #888; font-size: 11px; text-transform: uppercase;">Sync Instellingen</h4>
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                    <input type="checkbox" id="auto-sync-tgl" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span style="font-size: 14px;">Auto-sync (30s)</span>
                </label>
                <button class="btn" style="width: 100%; font-size: 12px;" onclick="runSync()">Manual Sync Nu</button>
            </div>
        </div>

        <div class="inspector-panel">
            <div style="padding:10px; font-size:10px; color:#555; background:#111;">DATA INSPECTOR</div>
            <div id="json-view">Wachtend op data...</div>
            <div id="log-area"></div>
        </div>
    </div>

    <div id="login-modal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#151921; padding:30px; border-radius:8px; border:1px solid #03a9f4; width:95%; max-width:450px;">
            <div id="login-choice">
                <h3 style="margin-top:0;">Verbinden met Familie</h3>
                <button class="btn" style="width:100%; margin-bottom:12px; padding:15px;" onclick="showManualTokenField()">üîë Ik heb al een Token</button>
                <button class="btn btn-wizard" style="width:100%; margin-bottom:12px; padding:15px; background: #03a9f4;" onclick="hideLoginModal(); startLoginFlow();">üìß Inloggen via E-mail</button>
                <button class="btn" style="width:100%; background:#333;" onclick="hideLoginModal()">Annuleren</button>
            </div>
            <div id="manual-token-form" style="display:none;">
                <input type="text" id="manual-token-input" placeholder="Plak hier je deviceAuthToken...">
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" style="flex:1;" onclick="loginWithToken()">Verbinden</button>
                    <button class="btn" style="background:#333; flex:1;" onclick="resetLoginModal()">Terug</button>
                </div>
            </div>
        </div>
    </div>

    <div id="rule-modal" class="modal" style="display:block !important; background:red;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Rule Settings</h2>
            <input type="hidden" id="edit-cat-id">
            <input type="hidden" id="edit-rule-id">
        
            <div class="form-group">
                <label>Dagen (Bitmask):</label>
                <input type="number" id="field-dayMask">
            </div>
            <div class="form-group">
                <label>Max Tijd (ms):</label>
                <input type="number" id="field-maxTime">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Start (minuten):</label>
                    <input type="number" id="field-start">
                </div>
                <div class="form-group">
                    <label>Eind (minuten):</label>
                    <input type="number" id="field-end">
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="field-perDay"> Per Dag
                </label>
            </div>
        
            <button class="save-modal-btn" onclick="saveModalChanges()">Tijdelijk Opslaan</button>
        </div>
    </div>

    <script src="state.js"></script>
    <script src="ui.js"></script>
    <script src="wizard.js"></script>
    <script src="sync.js"></script>
    <script src="tree.js"></script> 
    
    <script>
        // De switchServer en window.onload functies die je al had staan hieronder...
        const DEFAULT_TOKEN = "wCl56ssLezn0aDvgfPoL9hKpEWBq7F8J";
        let TOKEN = localStorage.getItem('timelimit_token') || DEFAULT_TOKEN;

        function updateTokenDisplay() {
            const display = document.querySelector('#active-token-display span');
            if (display) display.innerText = TOKEN;
        }

        async function switchServer(url) {
            try {
                const res = await fetch('set-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                if (res.ok) {
                    localStorage.setItem('selected_timelimit_server', url);
                    setTimeout(() => location.reload(), 500);
                }
            } catch (e) { console.error(e); }
        }

        window.onload = async () => { // Maak hier async van
            // 1. Herstel de dropdown selectie uit localStorage
            const savedServer = localStorage.getItem('selected_timelimit_server');
            const selector = document.getElementById('server-select');
    
            if (savedServer && selector) {
                selector.value = savedServer;
                addLog(`Server herstellen naar: ${savedServer}`);
        
                // --- DE FIX: Forceer de backend naar de opgeslagen server ---
                try {
                    await fetch('set-server', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: savedServer })
                });
                addLog("Backend gesynchroniseerd met opgeslagen server.");
                } catch (e) {
                    console.error("Kon backend niet synchroniseren bij opstarten", e);
                }
            }

            // 2. Bestaande acties
            updateTokenDisplay();
            if (TOKEN) runSync();
        };
    </script>
</body>
</html>