<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>TimeLimit UI v85 - Session Manager</title>
    <link rel="stylesheet" href="style.css?v=88">
</head>
<body>
    <header>
        <strong>TimeLimit UI v85</strong>
        <div>
            <button class="btn btn-wizard" data-debug-only="true" style="background: #673ab7;" onclick="startCreateFlow()">üÜï Nieuwe Familie</button>
            <button class="btn btn-wizard" style="background: #03a9f4;" onclick="startLoginFlow()">üîë Inloggen op Familie</button>
            <button class="btn" data-debug-only="true" style="background:#444" onclick="if (confirm('Weet je zeker dat je de UI wilt resetten?')) location.reload()">üîÑ Reset UI</button>
        </div>
        <div style="display: inline-block; margin-left: 15px; padding: 4px 8px; background: #151921; border-radius: 4px; border: 1px solid #333;">
          <span style="font-size: 10px; color: #888; text-transform: uppercase; margin-right: 5px;">Server:</span>
          <select id="server-select" onchange="switchServer(this.value)" style="background: transparent; color: #03a9f4; border: none; font-size: 11px; font-family: monospace; cursor: pointer; outline: none;">
            <option value="http://192.168.68.30:8080">üè† Lokaal</option>
            <option value="https://api.timelimit.io">üåç Officieel</option>
          </select>
        </div>
                <div style="display: inline-block; margin-left: 8px; padding: 4px 8px; background: #151921; border-radius: 4px; border: 1px solid #333;">
                    <span style="font-size: 10px; color: #888; text-transform: uppercase; margin-right: 6px;">Debug:</span>
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: #aaa;">
                        <input id="debug-toggle" type="checkbox" style="margin: 0; width: 14px; height: 14px;">
                        <span id="debug-toggle-label" style="font-family: monospace;">Off</span>
                    </label>
                </div>
                <div style="display: inline-block; margin-left: 8px; padding: 4px 8px; background: #151921; border-radius: 4px; border: 1px solid #333;">
                    <span style="font-size: 10px; color: #888; text-transform: uppercase; margin-right: 5px;">Seq:</span>
                    <span id="sequence-display" style="font-size: 11px; font-family: monospace; color: #4caf50;">0</span>
                    <button class="btn" style="margin-left: 6px; padding: 3px 6px; font-size: 10px; background:#333;" onclick="setSequencePrompt()">Set</button>
                    <button class="btn" style="margin-left: 4px; padding: 3px 6px; font-size: 10px; background:#2d5a2d; border-color:#4a8a4a;" onclick="safeBumpSequencePrompt()">Bump</button>
                </div>
    </header>

    <div id="wizard-ui" class="wizard-container">
        <div id="step-1" class="wizard-step" style="display:none;">
            <h3 id="step-1-title">Stap 1: E-mailadres</h3>
            <input type="email" id="mail" placeholder="e-mailadres">
            <button class="btn" onclick="runStep1()">Code aanvragen</button>
        </div>
        <div id="step-2" class="wizard-step" style="display:none;">
            <h3>Stap 2: Woord-code</h3>
            <input type="text" id="code" placeholder="woord1 woord2 woord3">
            <button class="btn" onclick="runStep2()">Valideer Code</button>
        </div>
        <div id="step-3" class="wizard-step" style="display:none;">
            <h3>Stap 3: Ouder Wachtwoord</h3>
            <p id="step-3-desc" style="font-size: 11px; color: #888; margin-bottom: 10px;"></p>
            <input type="password" id="pass" placeholder="Wachtwoord">
            <button id="btn-run-create" class="btn" style="display:none;" onclick="runStep3()">Familie Finaliseren & Aanmaken</button>
            <button id="btn-run-login" class="btn" style="display:none; background: #03a9f4;" onclick="runSignInStep3()">Inloggen & Dashboard Koppelen</button>
        </div>
        <button class="btn" style="background:transparent; color:#888; margin-top:10px;" onclick="showStep(0)">‚úñ Annuleren</button>
    </div>

    <div class="main-container">
        <div class="dashboard-view">
            <div id="session-info" data-debug-only="true" style="background: #151921; padding: 15px; border-radius: 8px; border: 1px solid #03a9f4; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #03a9f4; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Actieve Sessie</h4>
                <div id="active-token-display" style="font-family: monospace; font-size: 11px; color: #aaa; word-break: break-all; background: #050505; padding: 8px; border-radius: 4px; min-height: 20px;">
                    Token: <span style="color: #fff;">Laden...</span>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button class="btn" style="background: #f44336; flex: 1; font-size: 12px;" onclick="logout()">Uitloggen</button>
                    <button class="btn" style="background: #03a9f4; flex: 1; font-size: 12px;" onclick="showLoginModal()">Token Beheer</button>
                    <button class="btn" style="background: #2d5a2d; border-color: #4a8a4a; flex: 1; font-size: 12px;" onclick="showLoginModal(); showManualTokenField();">Ik heb al een Token</button>
                </div>
            </div>

            <div id="status-badge" class="status-badge status-offline">Sync Status...</div>

            <div id="ha-storage-panel" data-debug-only="true" style="margin-top: 20px; padding: 15px; background: #151921; border-radius: 8px; border: 1px solid #2b2f38;">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <h4 style="margin: 0; color: #8ab4f8; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">HA Storage Status</h4>
                    <div style="display:flex; gap:6px;">
                        <button class="btn" style="padding:4px 8px; font-size:10px; background:#2d5a2d; border-color:#4a8a4a;" onclick="if (window.exportHaStorage) window.exportHaStorage();">Export</button>
                        <button class="btn" style="padding:4px 8px; font-size:10px; background:#444;" onclick="document.getElementById('ha-storage-import-file').click();">Import</button>
                        <button class="btn" style="padding:4px 8px; font-size:10px; background:#333;" onclick="if (window.loadHaStorageStatus) window.loadHaStorageStatus();">Refresh</button>
                    </div>
                </div>
                <input id="ha-storage-import-file" type="file" accept="application/json" style="display:none;" onchange="if (window.importHaStorageFromFile) window.importHaStorageFromFile(event);">
                <div id="ha-storage-status" style="margin-top: 10px; font-size: 12px; color: #aaa;">Nog geen data geladen.</div>
                <div id="ha-storage-details" style="margin-top: 10px; font-size: 12px; color: #aaa;"></div>
                <div style="margin-top: 10px; border-top: 1px solid #232a35; padding-top: 10px;">
                    <div style="font-size: 11px; color: #666; text-transform: uppercase;">Account Geschiedenis (HA)</div>
                    <div style="border: 1px solid #232a35; border-radius: 6px; overflow: auto; max-height: 180px; margin-top: 8px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                            <thead style="background: #0b0e14; color: #888;">
                                <tr>
                                    <th style="text-align: left; padding: 6px;">Server</th>
                                    <th style="text-align: left; padding: 6px;">E-mail</th>
                                    <th style="text-align: left; padding: 6px;">Token</th>
                                    <th style="text-align: left; padding: 6px;">Seq</th>
                                    <th style="text-align: left; padding: 6px;">Laatst</th>
                                    <th style="text-align: left; padding: 6px;">Actie</th>
                                </tr>
                            </thead>
                            <tbody id="ha-storage-history-body">
                                <tr><td colspan="6" style="padding: 8px; color: #666;">Geen geschiedenis</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <h2>Gebruikers & Categorieen</h2>
            <div id="user-list">Gegevens ophalen via sync...</div>

            <h2 style="margin-top: 40px;">Device Overzicht</h2>
            <div id="device-overview-container" class="tree-container" style="padding: 12px;">
                Wachtend op device data...
            </div>


            <div style="margin-top: 30px; padding: 15px; background: #151921; border-radius: 8px; border: 1px solid #232a35; max-width: 300px;">
                <h4 style="margin: 0 0 10px 0; color: #888; font-size: 11px; text-transform: uppercase;">Sync Instellingen</h4>
                <label data-debug-only="true" style="display: flex; align-items: center; cursor: pointer; margin-bottom: 12px; gap: 8px;">
                    <input type="checkbox" id="encrypted-apps-toggle" style="width: 16px; height: 16px; margin-right: 6px; cursor: pointer;" onclick="if (window.setEncryptedAppsEnabled) window.setEncryptedAppsEnabled(this.checked)">
                    <span style="font-size: 12px;">Encrypted app lijst</span>
                    <span id="encrypted-apps-toggle-label" style="margin-left: auto; font-size: 11px; font-family: monospace; padding: 2px 8px; border-radius: 999px; border: 1px solid #333; background: #111; color: #bbb;">UIT</span>
                </label>
                <div data-debug-only="true" style="margin-bottom: 12px; padding: 10px; border-radius: 6px; border: 1px solid #232a35; background: #0f141b;">
                    <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 6px;">Encrypted app key</div>
                    <select id="encrypted-apps-device-id" style="width: 100%; padding: 8px; margin-bottom: 6px; background: #050505; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;"></select>
                    <input type="text" id="encrypted-apps-device-id-manual" placeholder="DeviceId (handmatig)" style="display:none; width: 100%; padding: 8px; margin-bottom: 6px; background: #050505; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                    <input type="text" id="encrypted-apps-key" placeholder="Base64 key (16 bytes)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #050505; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn" style="flex: 1; font-size: 11px; background:#2d5a2d; border-color:#4a8a4a;" onclick="if (window.saveEncryptedAppsKey) window.saveEncryptedAppsKey();">Opslaan</button>
                        <button class="btn" style="flex: 1; font-size: 11px; background:#333;" onclick="if (window.clearEncryptedAppsKeyInputs) window.clearEncryptedAppsKeyInputs();">Wissen</button>
                    </div>
                    <div id="encrypted-apps-keys" style="margin-top: 8px; font-size: 11px; color: #aaa;"></div>
                </div>
                <div data-debug-only="true" style="margin-bottom: 12px; padding: 10px; border-radius: 6px; border: 1px solid #232a35; background: #0f141b;">
                    <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 6px;">Parent keypair</div>
                    <input type="text" id="parent-public-key" placeholder="Public key (base64, 32 bytes)" style="width: 100%; padding: 8px; margin-bottom: 6px; background: #050505; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                    <input type="text" id="parent-private-key" placeholder="Private key (base64, 32 bytes)" style="width: 100%; padding: 8px; margin-bottom: 8px; background: #050505; border: 1px solid #333; border-radius: 4px; color: #fff; font-size: 12px;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn" style="flex: 1; font-size: 11px; background:#2d5a2d; border-color:#4a8a4a;" onclick="if (window.saveParentKeyPair) window.saveParentKeyPair();">Opslaan</button>
                        <button class="btn" style="flex: 1; font-size: 11px; background:#333;" onclick="if (window.clearParentKeyPairInputs) window.clearParentKeyPairInputs();">Wissen</button>
                        <button class="btn" style="flex: 1; font-size: 11px; background:#333;" onclick="if (window.clearParentKeyPair) window.clearParentKeyPair();">Verwijder</button>
                    </div>
                    <div id="parent-keypair-status" style="margin-top: 8px; font-size: 11px; color: #aaa;"></div>
                </div>
                <div data-debug-only="true" style="margin-bottom: 12px; padding: 10px; border-radius: 6px; border: 1px solid #232a35; background: #0f141b;">
                    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                        <div style="font-size: 11px; color: #888; text-transform: uppercase;">Key requests</div>
                        <div id="key-request-count" style="font-size: 10px; color: #666;">0</div>
                    </div>
                    <div id="key-request-indicator" style="margin-top: 6px; font-size: 11px; color: #777;">Nog geen status.</div>
                    <div id="key-request-list" style="margin-top: 8px; font-size: 11px; color: #aaa; max-height: 140px; overflow:auto;"></div>
                </div>
                <label style="display: flex; align-items: center; cursor: pointer; margin-bottom: 15px;">
                    <input type="checkbox" id="auto-sync-tgl" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                    <span style="font-size: 14px;">Auto-sync (30s)</span>
                </label>
                <button class="btn" style="width: 100%; font-size: 12px; margin-bottom: 10px;" onclick="runSync()">‚¨áÔ∏è Pull Sync (Server ‚Üí UI)</button>
                <button class="btn show-changes-btn" style="width: 100%; font-size: 12px; margin-bottom: 10px;" onclick="showChangesSummary()">üìù Wijzigingen Weergeven</button>
                <button class="btn show-changes-btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #2d5a2d; border-color: #4a8a4a; margin-bottom: 10px;" onclick="testSyncActions()">üß™ Test Sync (Log Acties)</button>
                <button class="btn show-changes-btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #ff9800; border-color: #f57c00; margin-bottom: 10px;" onclick="debugIntegrityCheck()">üîç Debug Integrity</button>
                <button class="btn show-changes-btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #e91e63; border-color: #c2185b; margin-bottom: 10px;" onclick="debugAddUserIntegrity()">üîç Debug AddUser</button>
                <button class="btn show-changes-btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #9c27b0; border-color: #7b1fa2; margin-bottom: 10px;" onclick="testCreateCategoryAndRule()">üéØ Test: Maak Category+Rule</button>
                <button class="btn" style="width: 100%; font-size: 12px; background: #d9534f; border-color: #d43f3a; font-weight: bold; margin-bottom: 10px;" onclick="executePushSync()">üöÄ Push Sync (UI ‚Üí Server)</button>
                <button class="btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #4caf50; border-color: #45a049; margin-bottom: 10px;" onclick="showAddChildModal()">üë∂ Kind Toevoegen</button>
                <button class="btn" data-debug-only="true" style="width: 100%; font-size: 12px; background: #6f4c4e; border-color: #8b6b6d;" onclick="showPasswordResetModal()">üîê Wachtwoord Hashes Bijwerken</button>
            </div>
        </div>

        <div class="inspector-panel">
            <div data-debug-only="true" class="inspector-debug">
                <div style="padding:10px; font-size:10px; color:#555; background:#111; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <span>DATA INSPECTOR</span>
                    <button class="btn" style="padding:4px 8px; font-size:10px; background:#2d5a2d; border-color:#4a8a4a;" onclick="copyInspectorToClipboard()">Copy All</button>
                </div>
                <div id="json-view">Wachtend op data...</div>
            </div>
            <div id="log-area"></div>
        </div>
    </div>

    <div id="login-modal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#151921; padding:30px; border-radius:8px; border:1px solid #03a9f4; width:95%; max-width:450px;">
            <div id="login-choice">
                <h3 style="margin-top:0;">Verbinden met Familie</h3>
                <button class="btn" style="width:100%; background:#333;" onclick="hideLoginModal()">Annuleren</button>
            </div>
            <div id="manual-token-form" style="display:none;">
                <input type="text" id="manual-token-input" placeholder="Plak hier je deviceAuthToken...">
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="btn" style="flex:1;" onclick="loginWithToken()">Verbinden</button>
                    <button class="btn" style="background:#333; flex:1;" onclick="resetLoginModal()">Terug</button>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #888; font-size: 11px; text-transform: uppercase;">Account Geschiedenis</h4>
                <button class="btn" style="padding: 6px 10px; font-size: 11px; margin-bottom: 8px; background:#333;" onclick="recordAccountHistoryFromCurrent()">Sessie toevoegen</button>
                <div style="border: 1px solid #232a35; border-radius: 6px; overflow: auto; max-height: 180px;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                        <thead style="background: #0b0e14; color: #888;">
                            <tr>
                                <th style="text-align: left; padding: 6px;">Server</th>
                                <th style="text-align: left; padding: 6px;">E-mail</th>
                                <th style="text-align: left; padding: 6px;">Token</th>
                                <th style="text-align: left; padding: 6px;">Seq</th>
                                <th style="text-align: left; padding: 6px;">Actie</th>
                            </tr>
                        </thead>
                        <tbody id="account-history-body">
                            <tr><td colspan="5" style="padding: 8px; color: #666;">Geen geschiedenis</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="password-reset-modal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#151921; padding:30px; border-radius:8px; border:1px solid #8b6b6d; width:95%; max-width:450px;">
            <h3 style="margin-top:0; color:#c9a89b;">üîê Wachtwoord Hashes Bijwerken</h3>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Voer je wachtwoord in om de signing hashes op te slagen voor sync.</p>
            <input type="password" id="password-reset-input" placeholder="Voer je wachtwoord in..." style="width:100%; padding:10px; margin-bottom:15px; background:#050505; border:1px solid #333; border-radius:4px; color:#fff;">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:#6f4c4e;" onclick="submitPasswordReset()">Bijwerken</button>
                <button class="btn" style="background:#333; flex:1;" onclick="hidePasswordResetModal()">Annuleren</button>
            </div>
            <div id="password-reset-status" style="margin-top:15px; font-size:12px; color:#aaa;"></div>
        </div>
    </div>

    <div id="add-child-modal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#151921; padding:30px; border-radius:8px; border:1px solid #4caf50; width:95%; max-width:450px;">
            <h3 style="margin-top:0; color:#4caf50;">üë∂ Kind Toevoegen</h3>
            <p style="color:#aaa; font-size:13px; margin-bottom:20px;">Voeg een kind toe aan de familie.</p>
            <input type="text" id="add-child-name-input" placeholder="Naam van het kind..." style="width:100%; padding:10px; margin-bottom:15px; background:#050505; border:1px solid #333; border-radius:4px; color:#fff;">
            <div style="display:flex; gap:10px;">
                <button class="btn" style="flex:1; background:#4caf50;" onclick="submitAddChild()">Toevoegen</button>
                <button class="btn" style="background:#333; flex:1;" onclick="hideAddChildModal()">Annuleren</button>
            </div>
            <div id="add-child-status" style="margin-top:15px; font-size:12px; color:#aaa;"></div>
        </div>
    </div>

    <div id="add-app-modal" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#151921; padding:30px; border-radius:8px; border:1px solid #03a9f4; width:95%; max-width:520px;">
            <h3 style="margin-top:0; color:#03a9f4;">üì± App Toevoegen</h3>
            <p style="color:#aaa; font-size:13px; margin-bottom:12px;">Kies een app om toe te voegen aan deze categorie.</p>
            <label style="display:flex; align-items:center; gap:8px; font-size:12px; color:#aaa; margin-bottom:10px;">
                <input type="checkbox" id="add-app-only-uncategorized" style="width:16px; height:16px;">
                Alleen apps zonder categorie
            </label>
            <input type="text" id="add-app-search" placeholder="Zoek app of package..." style="width:100%; padding:10px; margin-bottom:12px; background:#050505; border:1px solid #333; border-radius:4px; color:#fff;">
            <div id="add-app-list" style="border:1px solid #232a35; border-radius:6px; overflow:auto; max-height:260px;"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" style="background:#333; flex:1;" onclick="hideAddAppModal()">Sluiten</button>
            </div>
        </div>
    </div>

    <div id="rule-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Rule Settings</h2>
            <input type="hidden" id="edit-cat-id">
            <input type="hidden" id="edit-rule-id">
        
            <div class="form-group">
                <label>Dagen</label>
                <div id="day-picker" class="day-picker-container">
                    <button type="button" class="day-btn" data-bit="1">Ma</button>
                    <button type="button" class="day-btn" data-bit="2">Di</button>
                    <button type="button" class="day-btn" data-bit="4">Wo</button>
                    <button type="button" class="day-btn" data-bit="8">Do</button>
                    <button type="button" class="day-btn" data-bit="16">Vr</button>
                    <button type="button" class="day-btn" data-bit="32">Za</button>
                    <button type="button" class="day-btn" data-bit="64">Zo</button>
                </div>
                <input type="hidden" id="field-dayMask" value="127">
            </div>
            <div class="form-group">
                <label>Maximale Tijd (Limiet)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="number" id="input-hours" min="0" max="23" placeholder="0" style="width: 70px; margin-bottom: 0;">
                    <span>uur</span>
                    <input type="number" id="input-minutes" min="0" max="59" placeholder="0" style="width: 70px; margin-bottom: 0;">
                    <span>min</span>
                </div>
                <input type="hidden" id="field-maxTime" value="0">
            </div>
            <div style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label>Blokkade Start</label>
                    <input type="time" id="input-start-time" class="time-picker-input">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Blokkade Eind</label>
                    <input type="time" id="input-end-time" class="time-picker-input">
                </div>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="field-perDay"> Per Dag
                </label>
            </div>
        
            <button class="save-modal-btn" onclick="saveModalChanges()">Tijdelijk Opslaan</button>
        </div>
    </div>

    <script src="state.js?v=86"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tweetnacl/1.0.3/nacl.min.js" crossorigin="anonymous"></script>
    <script src="ui.js?v=100"></script>
    <script src="wizard.js?v=87"></script>
    <script src="sync.js?v=95"></script>
    <script src="tree.js?v=92"></script> 
    
    <script>
        // De switchServer en window.onload functies die je al had staan hieronder...
        const DEFAULT_TOKEN = "wCl56ssLezn0aDvgfPoL9hKpEWBq7F8J";
        let TOKEN = localStorage.getItem('timelimit_token') || DEFAULT_TOKEN;

        function updateTokenDisplay() {
            const display = document.querySelector('#active-token-display span');
            if (display) display.innerText = TOKEN;
        }

        function updateSequenceDisplay() {
            const display = document.getElementById('sequence-display');
            if (!display) return;
            if (typeof peekNextSequenceNumber === 'function') {
                display.innerText = String(peekNextSequenceNumber());
            } else {
                display.innerText = '0';
            }
        }

        function setSequencePrompt() {
            const current = typeof peekNextSequenceNumber === 'function' ? peekNextSequenceNumber() : 0;
            const input = prompt('Nieuwe sequence waarde (0 of hoger):', String(current));
            if (input === null) return;
            if (typeof setSequenceNumber !== 'function') return;
            setSequenceNumber(input);
            addLog(`Sequence ingesteld op ${String(peekNextSequenceNumber())}`);
        }

        function safeBumpSequencePrompt() {
            const current = typeof peekNextSequenceNumber === 'function' ? peekNextSequenceNumber() : 0;
            const input = prompt('Safe bump: hoeveel wil je optellen?', '100');
            if (input === null) return;
            const bump = Number.parseInt(input, 10);
            if (!Number.isFinite(bump) || bump <= 0) {
                addLog('Ongeldige bump-waarde. Gebruik een getal > 0.', true);
                return;
            }
            if (typeof setSequenceNumber !== 'function') return;
            setSequenceNumber(current + bump);
            addLog(`Sequence verhoogd naar ${String(peekNextSequenceNumber())} (+${bump})`);
        }
        
        function logout() {
            if (confirm("Weet je zeker dat je wilt uitloggen?\n\nDit verwijdert:\n- Je token\n- Opgeslagen wachtwoord hashes\n- Change tracking\n\nJe kunt daarna opnieuw inloggen.")) {
                TOKEN = "";
                localStorage.removeItem('timelimit_token');
                if (typeof scheduleHaStorageShadowSync === 'function') {
                    scheduleHaStorageShadowSync('logout');
                }
                
                // Wis ook de parentPasswordHash
                if (typeof clearParentPasswordHash === 'function') {
                    clearParentPasswordHash();
                }
                
                // Reset state
                if (typeof resetChangeTracking === 'function') {
                    resetChangeTracking();
                }

                if (typeof resetSequenceNumber === 'function') {
                    resetSequenceNumber();
                }
                
                updateTokenDisplay();
                document.getElementById('user-list').innerHTML = "<p style='color: #888;'>Uitgelogd. Gebruik 'Inloggen op Familie' om opnieuw in te loggen.</p>";
                document.getElementById('category-tree-container').innerHTML = "Wachtend op login...";
                document.getElementById('status-badge').innerText = "Uitgelogd";
                document.getElementById('status-badge').className = "status-badge status-offline";
                
                addLog("‚úÖ Volledig uitgelogd - alle lokale data gewist", false);
            }
        }

        async function switchServer(url) {
            try {
                const res = await fetch('set-server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });
                if (res.ok) {
                    localStorage.setItem('selected_timelimit_server', url);
                    if (typeof scheduleHaStorageShadowSync === 'function') {
                        scheduleHaStorageShadowSync('switch-server');
                    }
                    setTimeout(() => location.reload(), 500);
                }
            } catch (e) { console.error(e); }
        }

        window.onload = async () => { // Maak hier async van
            // 0. Laad opgeslagen wachtwoord hashes (essentieel voor HMAC signing)
            if (typeof loadParentPasswordHashFromStorage === 'function') {
                loadParentPasswordHashFromStorage();
            }

            if (typeof loadHaStorageAndApply === 'function') {
                await loadHaStorageAndApply();
            }
            
            // 1. Herstel de dropdown selectie uit localStorage
            const savedServer = localStorage.getItem('selected_timelimit_server');
            const selector = document.getElementById('server-select');
    
            if (savedServer && selector) {
                selector.value = savedServer;
                addLog(`Server herstellen naar: ${savedServer}`);
        
                // --- DE FIX: Forceer de backend naar de opgeslagen server ---
                try {
                    await fetch('set-server', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: savedServer })
                });
                addLog("Backend gesynchroniseerd met opgeslagen server.");
                } catch (e) {
                    console.error("Kon backend niet synchroniseren bij opstarten", e);
                }
            }

            // 2. Bestaande acties
            updateTokenDisplay();
            updateSequenceDisplay();
            if (typeof initDebugToggle === 'function') {
                initDebugToggle();
            }
            if (typeof initEncryptedAppsToggle === 'function') {
                initEncryptedAppsToggle();
            }
            if (typeof initEncryptedAppsKeyPanel === 'function') {
                initEncryptedAppsKeyPanel();
            }
            if (typeof initParentKeyPairPanel === 'function') {
                initParentKeyPairPanel();
            }
            if (TOKEN) runSync();
            if (typeof scheduleHaStorageShadowSync === 'function') {
                scheduleHaStorageShadowSync('page-load');
            }
            if (typeof loadHaStorageStatus === 'function') {
                loadHaStorageStatus();
            }
        };
    </script>
</body>
</html>